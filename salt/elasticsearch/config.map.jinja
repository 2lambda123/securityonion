# soup needs
# elasticsearch:esclustername pillar move to elasticsearch:cluster_settings:cluster:name
# move elasticsearch:true_cluster_name to elasticsearch:cluster_settings:cluster:name if true_cluster enabled
# elasticsearch:node_route_type moved

{% import_yaml 'elasticsearch/defaults.yaml' as ESCONFIG with context %}

{% if not salt['pillar.get']('elasticsearch:auth:enabled', False) %}
  {% do ESCONFIG.elasticsearch.cluster_settings.xpack.security.authc.anonymous.update({'username': 'anonymous_user', 'roles': 'superuser', 'authz_exception': 'true'}) %}
{% endif %}

{% if salt['pillar.get']('elasticsearch:true_cluster', False) %}
  {% do ESCONFIG.elasticsearch.cluster_settings.cluster.update({'name': salt['pillar.get']('elasticsearch:true_cluster_name')}) %} {# this is temporary #}
  {% if grains.id.split('_') | last in ['manager','managersearch'] %}
    {% if salt['pillar.get']('nodestab', {}) %}
      {% do ESCONFIG.elasticsearch.cluster_settings.node.update({'roles': ['master', 'data', 'remote_cluster_client']}) %}
      {% do ESCONFIG.elasticsearch.cluster_settings.discovery.update.({'seed_hosts': grains.master}) %}
      {% for SN, SNDATA in salt['pillar.get']('nodestab', {}).items() %}
        {% do ESCONFIG.elasticsearch.cluster_settings.discovery.update({'seed_hosts': SN.split('_')|first}) %}
      {% endfor %}
    {% endif %}
    {% if grains.id.split('_') | last == 'managersearch' %}
      {% do ESCONFIG.elasticsearch.cluster_settings.node.attr.update({'box_type': 'hot'}) %}
    {% endif %}
  {% else %}
    {% do ESCONFIG.elasticsearch.cluster_settings.node.update({'roles': ['data', 'ingest']}) %}
    {% do ESCONFIG.elasticsearch.cluster_settings.node.attr.update({'box_type': 'hot'}) %}
    {% do ESCONFIG.elasticsearch.cluster_settings.discovery.update({'seed_hosts': grains.master}) %}
  {% endif %}
{% endif %}

